## ch7

클러스터를 이용한 RabbitMQ 확장
- 클러스터 관리하기
- 큐의 위치가 속도에 미치는 영향
- 단계적으로 클러스터 설정하기
- 노드에 장애가 발생했을 때 수행할 작업

애플리케이션에서 메시지 배달을 보장하는 가용성이 높은 큐가 필요하거나 RabbitMQ 를 여러 애플리케이션의 중앙 메시징 허브로 사용할 수도 있다.

RabbitMQ 는 내장 클러스터링 기능을 통해 여러 서버로 확장할 수 있는 견고하고 응집력 있는 환경을 제공한다.



#### 클러스터
RabbitMQ 클러스터는 `둘 이상의 서버를 하나의 RabbitMQ 처럼 사용`할 수 있도록 한다.
RabbitMQ 클러스터는 익스체인지, 큐, 바인딩, 사용자, 가상호스트 등의 상태를 모든 노드에서 사용할 수 있다.
클러스터 내 한 개 노드로 발행된 메시지는 다른 노드의 큐로 라우팅된다.

RabbitMQ 환경에서 장애허용 시스템을 구성하려는 경우 `HA`큐를 사용한다.
`HA큐`는 여러 클러스터 노드에 걸쳐 있으며, 각 노드는 메시지 데이터를 포함해 동기화된 큐의 상태를 공유한다.
`HA큐`의 노드 중 하나가 다운돼도 클러스터의 다른 노드에는 영향이 없다.
장애가 발생한 노드가 다시 클러스터에 포함되면 장애가 발생한 동안 추가된 메시지가 모두 소비된 후 클러스터 내 다른 노드들과 동기화된다.


#### 클러스터 노드 유형
RabbitMQ 는 두 가지 노드 유형이 존재한다.
- `디스크 노드`
- `RAM 노드`

디스크 노드
클러스터의 런타임 상태를 RAM 과 디스크에 저장한다.
(런타임 상태 = 익스체인지, 큐, 바인딩, 가상 호스트, 사용자, 정책)

RAM 노드
클러스터의 런타임 상태를 메모리 DB에만 저장한다.

두 개 노드 유형은 메시지 디스크 저장여부와는 관련 없다.
`delivery-mode=2` 라면 노드의 유형에 관계없이 메시지는 디스크에 저장된다.


#### 노드 유형과 장애처리 동작
노드 또는 클러스터에 장애가 발한 경우
- 디스크 노드는 클러스터에 재접속 시 런타임 상태를 재구성한다.
- RAM 노드는 클러스터에 재접속 시 런타임 상태를 포함하지 않는다.
(장애 노드가 클러스터에 재접속 시 다른 노드들이 런타임 상태정보를 장애 노드에 전달한다.)


#### 통계노드
`rabbitmq-management 플러그인`을 사용하면 디스크 노드와 연결된 `통계 노드`를 볼 수 있다.
`통계 노드`는 클러스터의 각 노드에서 모든 통계 및 상태 데이터를 수집한다.
특정 시간에 클러스터 내에서 한 개 노드만 `통계 노드`가 된다.


#### 클러스터 및 큐 동작
클러스터에 발행한 메시지는 해당 큐가 클러스터의 어떤 노드에 있는지와 상관없이 올바르다 전달된다.
클러스터 내 각 노드로 리소스 사용률을 고르게 분산시키지 않고 큐의 위치를 고려하지 않는다면 성능상 악영향을 미칠 수 있다.


#### 노드 특정 소비자
RabbitMQ 는 클러스터의 메시지 처리량을 향상시키기 위해 가능한 경우 `새로 발생된 메시지를 기존의 소비자로 전달`하려고 한다.
but, 메시지가 남아있는 큐의 새 메시지는 클러스터를 통해 큐가 정의된 노드로 발행된다. 이 경우 큐가 정의된 노드와 소비자가 연결된 노드의 통신으로 성능이 저하될 수 있다.??

클러스터링 된 두 개 노드 (노드1, 노드2)가 있을 때 소비자는 노드1에 연결되어 있고 메시지는 노드2의 큐로 전달됐다고 하면 노드 2의 큐에서 노드1로 메시지를 전달하고 소비자는 노드1로 전달된 메시지를 처리한다. 
이는 불필요한 오버헤드로 작용한다.

소비자 연결 시에 큐의 위치를 고려할 수 있다면 메시지를 다른 노드에 전달하지 않고 바로 소비자에게 전달하며 오버헤드를 줄일 수 있다.

큐의 위치를 고려해서 소비자와 발행자를 적합한 노드에 연결한다면 클러스터 간 통신을 줄이면서 메시지 처리량을 늘릴 수 있다. 이는 HA 큐를 사용할 때만 적용된다.


#### 요약
RabbitMQ 클러스터는 메시징 아키텍처를 확장하고 메시지를 복제하는 강력한 방법이다.
클러스터 내 모든 노드로 메시지 발행 및 소비가 가능하지만 높은 메시지 처리량을 위해서 큐의 위치가 고려되어야 한다.











