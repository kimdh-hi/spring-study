## ch8 
클러스터 간 메시지 발행

서로 다른 RabbitMQ 클러스터 간 메시지를 전달하는 경우 Federation 플러그인을 추천한다.
Federation 플러그인은 한 클러스터에서 다른 클러스터로 메시지를 발행하는 두 가지 방법을 제공한다.

Federation 익스체인지를 사용하면 다른 RabbitMQ 서버, 다른 클러스터의 익스체인지에 발핸한 메시지를 자동으로 다운스트림 호스트에 연결한 익스체인지 혹은 큐에 전달한다.

퍼더레이션 큐를 사용하면 익스체인지가 아닌 단일 큐에서 메시지를 대상으로 지정할 수 있다.

목표는 메시지가 발행된 업스트림 노드에서 다운스트림 노드의 익스체인지 혹은 큐로 메시지를 전달하는 것이다.


#### 퍼더레이션 익스체인와 퍼더레이션 큐
Federation 플러그인의 두 가지 기본 구성 요소는 `페더레이션 익스체인지`와 `페더레이션 큐`이다.

페더레이션 익스체인지는 업스트림 노드의 익스체인지에 발행된 메시지를 다운스트림 노드의 동일한 이름의 익스체인지에 투명하게 발행할 수 있다.

페더레이션 큐는 업스트림 노드의 공유 큐를 다운스트림 노드가 소비자로 동작해서 여러 다운스트림 노드에 메시지를 라운드 로빈하는 기능을 제공한다.


#### 페더레이션 익스체인지
퍼더레이션 서버를 설정하려면 메시지를 필요로 하는 익스체인지에 정책을 적용하면 된다.
업스트림 서버에 퍼더레이션 익스체인지가 있는 경우 다운스트림 서버는 업스트림의 퍼더레이션 익스체인지의 이름과 동일한 퍼더레이션 정책을 만들어야 한다.
이제 해당 익스체인진에 큐를 연결하면 RabbitMQ 는 업스트림 서버에 연결하고 다운스트림 큐로 메시지를 발행한다.

업스트림 서버와 다운스트림 서버 사이 인터넷 연결이 끊어지는 상황은 걱정할 필요 없다.
연결이 끊어진 동안 발행된 메시지는 업스트림 서버의 로컬 큐에 저장된다. 시간이 지나면 다운스트림의 소비자가 메시지를 받아간다.


#### 페더레이션 큐
페더레이션 큐는 큐의 용량을 수평 확장할 수 있는 방법을 제공한다.
특정 큐의 활동이 급증하면서 병목이 되는 경우 유용하게 사용할 수 있다.
메시지 발행자는 업스트림 노드 또는 클러스터를 사용하고 메시지는 모든 다운스트림 노드의 동일한 이름의 큐로 분산된다.

다운스트림 큐에 소비자가 있는 경우에만 업스트림 큐에서 메시지를 수신한다.
소비자가 없는 큐에 메시지가 분산되는 것을 방지한다.


#### 설정
`fereration-management` 플러그인을 설치하면 RabbitMQ admin ui 의 Admin 탭에서 `Federation Status` 와 `Federation Upstream` 탭이 추가된다.



페더레이션 설정은 RabbitMQ의 정책 시스템 `(Admin > Policies)` 을 사용해서 관리된다.
정책은 정책의 이름과 패턴을 지정한다.
패턴에는 직접적인 문자열 매칭이나 정규 표현식을 사용할 수 있다.

정책 구성요소
- name
- pattern
- apply to
  - Exchange, Queue ...
- priority
- definition (key-value)